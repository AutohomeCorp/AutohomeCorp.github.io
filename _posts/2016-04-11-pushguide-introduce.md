---

layout: post          
title: PushGuide发布系统介绍
category: articles 
tags: [发布系统] 
author: jinlongwang 
comments: true  

---

# PushGuide发布系统介绍

## 介绍

### 作者介绍

本文作者是姓名<wangjinlong@autohome.com.cn>，主要负责汽车之家发布系统，CMDB系统的开发工作。

### 团队介绍

我们是汽车之家运维团队，由op和dev共同组成，负责汽车之家基础架构的研发和运维工作。
团队技术博客地址为 http://autohomeops.github.io/

![image](/images/cli_200px.png)

### 审稿人

姓名<xx@autohome.com.cn>

### 联系方式

可以通过邮件或者在官方技术博客留言跟我们交流。

## 前言

汽车之家发布系统，支撑着公司业务线的代码发布工作。

## 正文

### 背景

代码上线是运维日常工作中最重要的一部分。在没有发布系统之前， 所有的业务都需要运维来手动上线。 上线工作对运维人员来说是不小的工作量。 而且业务方代码没有标准规范。增量发布、目录混乱导致发布代码的版本控制混乱， 无法做到快速回滚到指定版本。为了解决这个问题，我们设计开发了汽车之家PushGuide发布系统。

### 设计原则

什么样的系统更适合于汽车之家的业务？ 首要要满足不同业务线的不同项目类型的发布，这些类型包括.net项目、java web项目、windows计划任务等。 其次，公司有大量的windows服务器， 发布系统需要同时支持windows和linux。最终我们选择基于`saltstack`自动化运维配置工具设计开发发布系统， 使用该工具的好处如下：

1. python开发，和运维开发的技术栈一致。对于以后的扩展，二次开发都很方便
2. 快速, 原生提供了http api支持
3. 支持windows


### 发布系统架构

#### 发布系统的整体架构

发布系统前端通过salt api与salt master进行通信， 发布任务描述信息到salt master。salt master通过salt命令调用我们自己开发的模块来完成一次发布任务。

![](/images/pushguide/pushguide_architecture.jpg)

#### 发布系统与其他系统如何合作完成代码发布

我们需要通过CI系统来打包代码， 通过配管系统来配置tomcat服务（这对java的发布尤为重要）。通过接口，我们在发布系统中获取到发布的版本和配置的tomcat信息

![](/images/pushguide/ci_push_cms.jpg)

### 遇到的问题

作为重要的代码发布系统， 稳定性上一定要有可靠的保证， 这样才能让业务方人员放心大胆的使用系统发布代码。但是在发布系统的使用过程中我们也遇到了一些问题

#### 确保salt的稳定性

由于PushGuide又是基于`saltstack`来完成代码的发布，所以对`saltstack`的运维又显得很重要。在前期的使用的我们经常遇到由于`salt`的问题导致发布系统出现不可用的情况。所以我们优化了整个`salt`的架构。通过使用多机房multi master来保证salt的稳定性。关于salt的高可用方案，网络上也有一些其他做法如加入代理层，重写returner模块等方法。但从效果看，目前的multi master可以满足我们现在的发布需求。

#### 代码的规范

系统使用前期，由于业务方的代码不够规范，比如我们在现实场景中会遇到有的业务方把业务代码和日志文件放在一起，代码目录非常大，导致发布的失败。所以对于发布系统的来说，我们不能仅仅是发布代码， 同时可以制定代码，目录规范来约束业务方规范自己的代码。

#### 监控

对于发布系统web服务的监控自然是必不可少的， 同时我们还定时对发布系统的用到的主机的salt连通性进行检测， 发现有minion不可用情况及时处理， 避免在发布时失败的情况

### PushGuide发布系统的特点介绍

#### 多种发布形式支持
发布系统设计之初，就想到了会有不同类型的发布情况。我们的发布系统支持.net站点发布， windows的计划任务发布， windows service发布， tomcat等多种发布形式。 在任务的描述文件中会有对发布类型的标识， 在扩展模块执行操作时会根据发布类型的不同， 执行不同的操作从而完成这个功能

#### 自动回滚

PushGuide可以配置自动回滚功能， 每次任务如果发布失败， 可以选择是否自动回滚到上一个发布成功的版本

#### 异步发布

通过引入celery， 异构整个发布逻辑。提高发布过程的体验 

#### 可视化

可视化是指对整个发布记录的统计结果提供可视化的数据分析展示，业务线人员通过该视图，对自己业务线的发布情况做到心中有数。对某一次发布的过程可视化， 明确的展示出现在发布到哪一个步骤， 又或者是哪个步骤出现问题。

### 小结

发布系统马上要接入个公司的所有业务线， 这对我们来说是一个不小的挑战，如何优化我们的系统， 提高系统的稳定性， 如何让用户体验更好，满足更多需求。我们还有很长的路要走。

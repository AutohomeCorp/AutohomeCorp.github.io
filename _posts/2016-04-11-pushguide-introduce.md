---

layout: post          
title: PushGuide发布系统介绍
category: articles 
tags: [发布系统] 
author: jinlongwang 
comments: true  

---

# PushGuide发布系统介绍

## 简介

发布系统，支撑着公司所有业务线的代码发布工作。

代码发布是运维日常工作中最重要的一部分，但大量的代码手工上线工作，对运维人员来说是不小的工作量。而且大量代码的增量覆盖，手动上线，使得代码的版本控制混乱，无法快速上线，快速回滚到指定版本。结合业务方不同类型项目（如.net, java等）需求，我们设计开发了pushguide代码发布系统。具有支持多种类型代码发布，代码自动回滚等特点。

## 发布系统架构介绍

PushGuide发布系统基于`saltstack`自动化运维配置工具设计。之所以我们选择这个工具的原因是： 

1. 公司有大量的windows服务器，调研过其他的配置工具，`saltstack`对windows下的支持最好。
2. python开发，和运维开发的技术栈一致。对于以后的扩展，二次开发都很方便
3. 快速, 原生提供了http api支持

### 发布系统的整体架构
发布系统前端通过salt api与salt master进行通信， 发布任务描述信息到salt master。salt master通过salt命令调用自己开发的模块来完成一次发布任务

![](/images/pushguide/pushguide_architecture.jpg)

### 发布系统与其他系统如何合作完成代码发布

![](/images/pushguide/ci_push_cms.jpg)

## 发布系统的稳定性保证

作为重要的代码发布系统， 稳定性上一定要有可靠的保证， 这样才能让业务方人员放心大胆的使用系统发布代码。由于PushGuide又是基于`saltstack`来完成代码的发布，所以对`saltstack`的运维又显得很重要。我们主要做到以下几点来保证发布系统的稳定

### 确保salt的稳定性

在架构上，我们使用了多机房multi master来保证salt的稳定性。关于salt的高可用方案，网络上也有一些其他做法如加入代理层，重写returner模块等方法。但从效果看，目前的multi master可以满足我们现在的发布需求。

### 代码的规范

对于发布系统的来说，我们不能仅仅是发布代码， 同时可以制定代码，目录规范来约束业务方规范自己的代码。比如我们在现实场景中会遇到有的业务方把业务代码和日志文件放在一起，导致代码目录非常大，这本来是不合理的。我们可以约束业务方来整理自己的代码目录。

### 监控

对于发布系统web服务的监控自然是必不可少的， 同时我们还定时对发布系统的用到的主机的salt连通性进行检测， 发现有minion不可用情况及时处理， 避免在发布时失败的情况

## PushGuide发布系统的特点介绍

### 多种发布形式支持
发布系统设计之初，就想到了会有不同类型的发布情况。我们的发布系统支持.net站点发布， windows的计划任务发布， windows service发布， tomcat等多种发布形式。 在任务的描述文件中会有对发布类型的标识， 在扩展模块执行操作时会根据发布类型的不同， 执行不同的操作从而完成这个功能

### 自动回滚

PushGuide可以配置自动回滚功能， 每次任务如果发布失败， 可以选择是否自动回滚到上一个发布成功的版本

### 异步发布

通过引入celery， 异构整个发布逻辑。提高发布过程的体验 

### 可视化

可视化是指对整个发布记录的统计结果提供可视化的数据分析展示，业务线人员通过该视图，对自己业务线的发布情况做到心中有数。对某一次发布的过程可视化， 明确的展示出现在发布到哪一个步骤， 又或者是哪个步骤出现问题。
